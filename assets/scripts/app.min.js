(function(exports){var cache,bubblehash,bubblehashOptions,notify,xhr,manifest=[];if(!(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB)&&!JSON&&!(window.mozRTCPeerConnection||window.webkitRTCPeerConnection)){alert("BubbleHash requires technology not present in your web browser.\n\nPlease download one of the latest versions of Chrome, Firefox, or Opera for an optimal compatibility.");window.location="https://www.google.com/intl/en/chrome/browser/"}var XHR=function(){function XHR(){this.request=new XMLHttpRequest;this.__header={};this.__data={}}XHR.prototype.header=function headers(key,value){if(arguments.length<2){if(typeof key==="string"){return this.__header[key]}for(value in key){this.__header[value]=key[value]}}else{this.__header[key]=value;return this}};XHR.prototype.data=function dataSetter(obj){if(arguments.length===0){return this.__data}this.__data=obj;return this};XHR.prototype.get=function get(url,callback){this.send("get",url,callback);return this};XHR.prototype.post=function(url,callback){this.send("post",url,callback);return this};XHR.prototype.send=function send(type,url,callback){var queryString="",queryIndex,key;if(this.__data){queryString="json="+JSON.stringify(this.__data);if(type==="get"){queryIndex=url.indexOf("?");if(queryIndex!==-1){url.replace("?","?"+queryString+"&")}}}this.request.open(type,url);for(key in this.__header){this.request.setRequestHeader(key,this.__header[key])}this.request.onload=callback;if(type==="post"){this.request.setRequestHeader("Content-type","application/x-www-form-urlencoded");this.request.send(queryString)}else{this.request.send()}};return XHR}();cache=function(){var elements={};$('[id|="ui"]').each(function(){var key=this.id.match(/^ui-(.+)$/)[1];elements[key]=$(this)});return elements}();bubblehashOptions={};bubblehashOptions.peer={};bubblehashOptions.peer.key="mbv2swgd5tztcsor";bubblehashOptions.peer.config={iceServers:[{url:"stun:stun4.l.google.com:19302"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"},{url:"turn:numb.viagenie.ca:3478",username:"hansoksendahl@gmail.com",credential:"num0mg!!"}]};bubblehashOptions.peer.debug=0;bubblehashOptions.log=true;notify=function(){var i=0,messages={};messages.welcome="BubbleHash by OX-Design.";messages.socket="Connected to websocket.";messages.manifestUpdate="Updated peer manifest.";messages.searching="Searching for peers.";messages.general="An error occured.\n\n";messages.recvConnection="Remote dataconnection received!";messages.xhrError="Could not request manifest file.";messages.xhrTimeout="Timed out while requesting manifest file.";messages.manifestGet="Got peer manifest.";messages.connection="Connected to BubbleHash!";messages.empty="Lost connection to BubbleHash!";return function(type,message){message=messages[message]||message;var alertBox=cache[type].clone(),displayMessage=message;alertBox.attr("id",type+i);alertBox.find(".message").html(displayMessage);cache.alertContainer.prepend(alertBox);alertBox.show().alert();window.setTimeout(function(){alertBox.fadeTo(500,0).slideUp(500,function(){alertBox.remove()})},3e3);i+=1}}();var updateStatus=function(){var statuses=$("[id^=ui-status]");return function statusUpdate(status){statuses.hide();cache["status"+status[0].toUpperCase()+status.slice(1)].show();if(status==="on"){cache.search.removeAttr("disabled");cache.searchQuery.removeAttr("disabled")}else{cache.search.attr("disabled","disabled");cache.searchQuery.attr("disabled","disabled")}}}();xhr=function(){var domain="http://mudb.org",length=25,key="ZZZZ",out={},xhr;xhr=new XHR;out.get=function(callback){xhr.get(domain+"/get/"+key,callback)};out.set=function(manifest,callback){manifest.__id=key;xhr.data(manifest).post(domain+"/set/json",callback)};out.request=xhr.request;return out}();var peerOpen=function(id){xhr.get(manifestGet)};var manifestGet=function(){var data=this.responseText!==""?JSON.parse(this.responseText):{};notify("success","manifestGet");data.manifest=data.manifest||[];data.manifest=data.manifest.filter(function(error){return error!==bubblehash.peer.id});data.manifest=data.manifest.slice(0,19);xhr.set({manifest:[bubblehash.peer.id].concat(data.manifest)},function(){notify("info","manifestUpdate")});function retry(){data.manifest=data.manifest.slice(1);updateStatus("connecting");if(data.manifest.length>0){notify("info","searching");initialConnection()}else{peerOpen()}}function initialConnection(){var dataConnection=bubblehash.join(data.manifest[0]);dataConnection.once("error",retry);dataConnection.once("open",function(){bubblehash.peer.removeListener("error",retry);dataConnection.removeListener("close",retry);bubblehash.once("empty",function(){updateStatus("connecting");peerOpen()});updateStatus("on");notify("success","connection")})}initialConnection()};var queries=function(){var out={},store;db.open({server:"BubbleHashDemo",version:1,schema:{bubbles:{key:{keyPath:"id",autoIncrement:true},indexes:{created:{},modified:{},hash:{}}}}}).done(function(s){store=s});out.read=function(key,callback){store.bubbles.query().filter("hash",murmurHash3.x86.hash128(key)).execute().done(callback)};out.create=function(key,value,callback){store.bubbles.add({hash:murmurHash3.x86.hash128(key),created:(new Date).getTime(),modified:(new Date).getTime(),value:value}).done(callback)};out.update=function(key,value,callback){store.bubbles.update({hash:murmurHash3.x86.hash128(key),created:value.created,modified:(new Date).getTime(),value:value.value})};out.destroy=function(key,callback){store.bubbles.remove(key).done(callback)};return out}();var searchSubmit=function(){function regexRange(from,to){to=to||0;from=from.toString(16);fromLen=from.length>4?from.length:4;to=to.toString(16);toLen=to.length>4?to.length:4;if(to!=="0"){return"\\u"+("0000"+from).slice(-fromLen)+"-\\u"+("0000"+to).slice(-toLen)+""}else{"\\u{"+("0000"+from).slice(-fromLen)+"}"}}LATIN_ACCENTS=[regexRange(192,214),regexRange(216,246),regexRange(248,255),regexRange(256,591),regexRange(595,596),regexRange(598,599),regexRange(601),regexRange(603),regexRange(611),regexRange(616),regexRange(623),regexRange(626),regexRange(649),regexRange(651),regexRange(699),regexRange(768,879),regexRange(7680,7935)].join("");NON_LATIN_HASHTAG_CHARS=[regexRange(1024,1279),regexRange(1280,1319),regexRange(11744,11775),regexRange(42560,42655),regexRange(1425,1471),regexRange(1473,1474),regexRange(1476,1477),regexRange(1479),regexRange(1488,1514),regexRange(1520,1524),regexRange(64274,64296),regexRange(64298,64310),regexRange(64312,64316),regexRange(64318),regexRange(64320,64321),regexRange(64323,64324),regexRange(64326,64335),regexRange(1552,1562),regexRange(1568,1631),regexRange(1646,1747),regexRange(1749,1756),regexRange(1758,1768),regexRange(1770,1775),regexRange(1786,1788),regexRange(1791),regexRange(1872,1919),regexRange(2208),regexRange(2210,2220),regexRange(2276,2302),regexRange(64336,64433),regexRange(64467,64829),regexRange(64848,64911),regexRange(64914,64967),regexRange(65008,65019),regexRange(65136,65140),regexRange(65142,65276),regexRange(8204,8204),regexRange(3585,3642),regexRange(3648,3662),regexRange(4352,4607),regexRange(12592,12677),regexRange(43360,43391),regexRange(44032,55215),regexRange(55216,55295),regexRange(65441,65500)].join("");CJ_HASHTAG_CHARACTERS=[regexRange(12449,12538),regexRange(12540,12542),regexRange(65382,65439),regexRange(65296,65305),regexRange(65313,65338),regexRange(65345,65370),regexRange(12353,12438),regexRange(12441,12446),regexRange(13312,19903),regexRange(19968,40959),regexRange(131072,173791),regexRange(173824,177983),regexRange(177984,178207),regexRange(194560,195103),regexRange(12291),regexRange(12293),regexRange(12347)].join("");HASHTAG_ALPHA="[a-z_"+LATIN_ACCENTS+NON_LATIN_HASHTAG_CHARS+CJ_HASHTAG_CHARACTERS+"]";HASHTAG_ALPHANUMERIC="[a-z0-9_"+LATIN_ACCENTS+NON_LATIN_HASHTAG_CHARS+CJ_HASHTAG_CHARACTERS+"]";HASHTAG=new RegExp("(#|ï¼ƒ)("+HASHTAG_ALPHANUMERIC+"*"+HASHTAG_ALPHA+HASHTAG_ALPHANUMERIC+"*)","i");return function(){var val=cache.searchQuery.val(),tags=[],match;if(HASHTAG.test(val)){match=HASHTAG.exec(val);if(match!==null){cache.search.data("hashtag",match[1])}}else{notify("danger","OMG! Invalid hashtag.")}}}();(function(){$('[rel="tooltip"]').tooltip()})();bubblehash=new BubbleHash(bubblehashOptions);cache.searchBtn.on("click",function(){$(this).closest("form").trigger("submit")});cache.search.on("submit",function(){searchSubmit();return false});(function(){var hashTags=["#test","#awesome","#sandbox"];cache.searchQuery.attr("placeholder",hashTags[Math.floor(Math.random()*hashTags.length)])})();bubblehash.peer.on("open",function(){notify("success","socket");updateStatus("connecting");peerOpen()});bubblehash.peer.once("connection",function(){notify("success","recvConnection");updateStatus("on")});exports.queries=queries;exports.bubblehash=bubblehash;notify("info","welcome")})(this);