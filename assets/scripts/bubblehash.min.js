function logger(messages,prefix){prefix=prefix?prefix+": ":"";var out={};function log(type,message){console[type](message)}function logCode(code,type,callback){var message=prefix+messages[code];return function(e){if((type==="error"||type==="warning")&&(Object.prototype.toString.call(e).indexOf("Error")!==-1||typeof e==="string")){message+="\n\n"+(e.stack?e.stack:e)}log(type,message);if(callback){callback.apply(this,arguments)}}}out.warning=function(code,callback){return logCode(code,"warning",callback)};out.error=function(code,callback){return logCode(code,"error",callback)};out.message=function(code,callback){return logCode(code,"log",callback)};return out}var xhr=function xhr(){var logMessages={},log;logMessages[0]="We get signal!";logMessages[1]="Opening connection...";logMessages[8192]="Connction attempt timed out.";logMessages[8193]="Lost signal.";log=logger(logMessages,"Signal");return function init(url){var request=new XMLHttpRequest,out={},headers={},data;request.ontimeout=log.message(8192);request.onerror=log.message(8193);function send(type,callback){var queryString="",queryIndex,key;if(data){queryString="json="+JSON.stringify(data);if(type==="get"){queryIndex=url.indexOf("?");if(queryIndex!==-1){url.replace("?","?"+queryString+"&")}}}request.open(type,url);for(key in headers){request.setRequestHeader(key,headers[key])}request.onload=callback;if(type==="post"){request.setRequestHeader("Content-type","application/x-www-form-urlencoded");request.send(queryString)}else{request.send()}}out.headers=function headers(key,value){if(arguments.length<2){if(typeof key==="string"){return headers[key]}for(value in key){headers[value]=key[value]}}else{headers[key]=value}};out.data=function dataSetter(obj){if(arguments.length===0){return data}data=obj;return out};out.get=function get(callback){send("get",callback);return out};out.post=function(callback){send("post",callback);return out};return out}}();var rtc=function rtc(){var peerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,iceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,sessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,logMessages={};logMessages[0]="Data channel established.";logMessages[1]="Creating an offer.";logMessages[2]="Creating an answer.";logMessages[3]="Setting local description.";logMessages[4]="Setting remote description.";logMessages[8192]="An error occured while setting the local description.";logMessages[8193]="An error occured creating an offer.";logMessages[8194]="An error occured creating an answer.";logMessages[8195]="An error occured while setting the remote description.";logMessages[16]="Data channel opened.";logMessages[17]="Data channel message received.";logMessages[18]="Data channel closed.";logMessages[8208]="Error on data channel.";var log=logger(logMessages,"RTC");return function init(server,options){var connection=new peerConnection(server,options),out={};out.connection=connection;function createOffer(success,options){success=log.message(1,success);options=options||{};connection.createOffer(success,log.error(8193),options)}function createAnswer(success,options){success=log.message(2,success);options=options||{};connection.createAnswer(success,log.error(8194),options)}function setLocalDescription(description,success){description=typeof description==="string"?JSON.parse(description):description;success=log.message(3,success);var dict=new sessionDescription(description);connection.setLocalDescription(dict,function(){success(dict)},log.error(8192))}function setRemoteDescription(description,success){description=typeof description==="string"?JSON.parse(description):description;success=log.message(4,success);var dict=new sessionDescription(description);connection.setRemoteDescription(dict,function(){success(dict)},log.error(8195))}out.open=function(callback){createOffer(function(description){setLocalDescription(description,callback)},options)};out.call=function(remoteDescription,callback,options){setRemoteDescription(remoteDescription);createAnswer(function(localDescription){setLocalDescription(localDescription);callback(localDescription)},options)};out.answer=function(description){setRemoteDescription(description)};return out}}();if(!(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB)&&!JSON&&!(window.mozRTCPeerConnection||window.webkitRTCPeerConnection)){alert("BubbleHash requires technology not present in your web browser.\n\nPlease download one of the latest versions of Chrome, Firefox, or Opera for an optimal compatibility.");window.location="https://www.google.com/intl/en/chrome/browser/"}var iFace={},server,options,commSilo,dataChannelName,leaseTime,heartbeatTime,timer;dataChannelName="BubbleHash";["glfStatusOn","glfStatusOff","fldLocalOffer","fldRemoteOffer","fldRemoteAnswer","fldLocalAnswer","modLocalOffer","modRemoteOffer","navInvite","navJoin","btnCreateOffer","btnAcceptAnswer","btnCreateAnswer","btnCancel"].forEach(function(e){iFace[e]=$("#"+e)});commSilo="http://mudb.org";leaseTime=6e5;heartbeatTime=5e3;server={iceServers:[{url:"stun:stun4.l.google.com:19302"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"},{url:"turn:numb.viagenie.ca:3478",username:"hansoksendahl@gmail.com",credential:"num0mg!!"}]};options={optional:[{DtlsSrtpKeyAgreement:true},{RtpDataChannels:true}]};pc=rtc(server,options);dc=pc.connection.createDataChannel(dataChannelName);function shutdown(){dc.close();pc.connection.close();dc=void 0;pc=void 0}function setOffer(){shutdown();pc=rtc(server,options);dc=pc.connection.createDataChannel(dataChannelName);bindDataChannelHandlers(dc);pc.open(function(description){xhr(commSilo+"/set/json").data(description).post(function(){var data=JSON.parse(this.responseText);iFace.fldLocalOffer.val(data.url);iFace.modLocalOffer.modal();iFace.fldLocalOffer.focus();timer=setInterval(listenForAnswer(data),heartbeatTime)})})}function listenForAnswer(originalData){return function(){xhr(originalData.url).get(function(){var data=JSON.parse(this.responseText);if(data.__timestamp!==originalData.__timestamp){clearInterval(timer);pc.answer(data)}})}}function acceptAnswer(val){xhr(val).get(function(){var data=JSON.parse(this.responseText);pc.answer(data)})}function getOffer(){iFace.modRemoteOffer.modal();iFace.fldRemoteOffer.val("").focus();iFace.btnCreateAnswer.click(setAnswer)}function setAnswer(){shutdown();pc=rtc(server,options);bindPeerConnectionHandlers(pc);xhr(iFace.fldRemoteOffer.val()).get(function(){var data=JSON.parse(this.responseText);pc.call(data,function(description){data.__timestamp=void 0;data.sdp=description.sdp;data.type=description.type;xhr(commSilo+"/set/json").data(data).post()})})}function bindPeerConnectionHandlers(connection){connection.connection.ondatachannel=function(event){dc=event.channel;bindDataChannelHandlers(dc)}}function bindDataChannelHandlers(channel){channel.onopen=function(){console.log("Data channel opened.");iFace.glfStatusOff.hide();iFace.glfStatusOn.show();iFace.modRemoteOffer.modal("hide");iFace.modLocalOffer.modal("hide")};channel.onclose=function(){console.log("Data channel closed.");iFace.glfStatusOn.hide();iFace.glfStatusOff.show()};channel.onmessage=function(event){console.log(event.data)};channel.onerror=function(err){console.error(err)};pc.connection.onicecandidate=function(event){if(event.candidate){pc.connection.addIceCandidate(event.candidate);if(dc.readyState==="open"){dc.send(JSON.stringify({type:"iceCandidace",candidate:event.candidate}))}}}}function fldSelect(){this.select()}function fldMouseOver(){this.focus();return false}function fldMouseUp(){return false}iFace.fldLocalOffer.focus(fldSelect).mouseover(fldMouseOver).mouseup(fldMouseUp);iFace.fldLocalAnswer.focus(fldSelect).mouseover(fldMouseOver).mouseup(fldMouseUp);iFace.navInvite.click(setOffer);iFace.navJoin.click(getOffer);iFace.btnCancel.click(shutdown);